# -----------------------------------------------------------------------------------
#            ditzz RDP | Powered by ditzz-devnest
# -----------------------------------------------------------------------------------
# Deskripsi:
# Alur kerja ini akan menyiapkan sebuah runner GitHub Actions dengan sistem operasi
# Windows 11 ARM, mengaktifkan Remote Desktop Protocol (RDP), dan membuat sebuah
# tunnel aman menggunakan Ngrok. Anda akan mendapatkan kredensial untuk login.
#
# Cara Menjalankan:
# 1. Buka tab "Actions" di repositori GitHub Anda.
# 2. Pilih alur kerja "üöÄ ditzz RDP (Ngrok | Win11-ARM)" dari daftar.
# 3. Klik tombol "Run workflow", lalu klik "Run workflow" lagi.
# 4. Tunggu hingga proses berjalan dan lihat output di langkah "‚úÖ Tampilkan Info Koneksi".
# -----------------------------------------------------------------------------------

name: "üöÄ ditzz RDP (Ngrok | Win11-ARM)"

on:
  workflow_dispatch:

jobs:
  rdp-session:
    name: "üñ•Ô∏è Windows 11 ARM | RDP Session"
    runs-on: windows-11-arm
    timeout-minutes: 360 # Batas waktu maksimal agar sesi tidak terputus

    steps:
      - name: "‚îå üìù Parameter Sesi"
        shell: pwsh
        run: |
          Write-Host "==========================================================================" -ForegroundColor Green
          Write-Host "             üöÄ Memulai Sesi RDP untuk ditzz-devnest" -ForegroundColor Cyan
          Write-Host "=========================================================================="
          Write-Host "üîπ Sistem Operasi : Windows 11 ARM"
          Write-Host "üîπ Metode Akses   : RDP via Ngrok TCP Tunnel"
          Write-Host "üîπ Aktor          : ${{ github.actor }}"
          Write-Host "üîπ Repositori     : ${{ github.repository }}"
          Write-Host "=========================================================================="

      - name: "‚îú üîê Validasi Ngrok Auth Token"
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if (-not $env:NGROK_AUTH_TOKEN) {
            Write-Error "‚ùå Secret 'NGROK_AUTH_TOKEN' tidak ditemukan!"
            Write-Error "Harap tambahkan secret tersebut di pengaturan repositori Anda."
            exit 1
          }
          Write-Host "‚úÖ Secret Ngrok berhasil divalidasi." -ForegroundColor Green
          
      - name: "‚îú ‚öôÔ∏è Konfigurasi RDP dan Buat Pengguna"
        shell: pwsh
        run: |
          Write-Host "üîê Membuat kata sandi yang aman untuk pengguna RDP..."
          # Membuat kata sandi acak dengan 16 karakter
          $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object { [char]$_ })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          Write-Host "üë§ Membuat pengguna 'ditzz' dan menambahkannya ke grup Administrator..."
          New-LocalUser -Name "ditzz" -Password $securePass -FullName "ditzz-devnest" -Description "Temporary RDP User"
          Add-LocalGroupMember -Group "Administrators" -Member "ditzz"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ditzz"
          
          Write-Host "‚úÖ Pengguna 'ditzz' berhasil dibuat." -ForegroundColor Green
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

          Write-Host "üîß Mengaktifkan Remote Desktop dan membuka port firewall..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="Allow RDP" dir=in action=allow protocol=TCP localport=3389
          
          Write-Host "‚úÖ Konfigurasi RDP dan Firewall selesai." -ForegroundColor Green

      - name: "‚îú  tunnel üåê Instal Ngrok dan Buat Tunnel"
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          Write-Host "üì• Mengunduh Ngrok Agent untuk ARM64..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-arm64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip
          
          Write-Host "üîë Mengautentikasi Ngrok..."
          .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          Write-Host "üöÄ Memulai Ngrok TCP Tunnel untuk port 3389..."
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -NoNewWindow
          
          Write-Host "‚úÖ Ngrok Tunnel berhasil dimulai di background." -ForegroundColor Green
          
      - name: "‚îî ‚úÖ Tampilkan Info Koneksi & Jaga Sesi"
        shell: pwsh
        run: |
          Write-Host "‚è≥ Menunggu Ngrok Tunnel siap (10 detik)..."
          Start-Sleep -s 10
          
          # Mengambil URL dari API lokal Ngrok
          $tunnels = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
          $tcpTunnel = $tunnels.tunnels | Where-Object { $_.proto -eq 'tcp' }
          if (!$tcpTunnel) {
              Write-Error "‚ùå Gagal mendapatkan alamat Ngrok Tunnel!"
              exit 1
          }
          
          $rdpAddress = $tcpTunnel.public_url.Replace("tcp://", "")
          
          Write-Host "==========================================================================" -ForegroundColor Green
          Write-Host "                       ‚úÖ SESI RDP ANDA SIAP ‚úÖ" -ForegroundColor Cyan
          Write-Host "=========================================================================="
          Write-Host "üíª Alamat RDP      : $rdpAddress" -ForegroundColor White
          Write-Host "üë§ Nama Pengguna   : ditzz" -ForegroundColor White
          Write-Host "üîë Kata Sandi      : ${{ env.RDP_PASSWORD }}" -ForegroundColor White
          Write-Host "=========================================================================="
          Write-Host "Gunakan informasi di atas untuk terhubung menggunakan Remote Desktop Client." -ForegroundColor Yellow
          Write-Host "Sesi ini akan tetap aktif hingga Anda membatalkan alur kerja secara manual." -ForegroundColor Yellow
          
          # Loop tak terbatas untuk menjaga runner tetap aktif
          while ($true) {
              $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Write-Host "[$timestamp] Sesi RDP aktif. Tekan 'Cancel workflow' untuk menghentikan."
              Start-Sleep -Seconds 300
          }
