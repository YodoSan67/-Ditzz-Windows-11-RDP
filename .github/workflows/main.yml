# -----------------------------------------------------------------------------------
#            ditzz RDP | Powered by ditzz-devnest (v4 - Robust Tailscale)
# -----------------------------------------------------------------------------------
# Deskripsi:
# Alur kerja ini menggunakan Tailscale untuk membuat koneksi RDP yang aman,
# andal, dan bersih ke runner Windows 11 ARM.
#
# Prasyarat:
# 1. Buat secret GitHub bernama `TAILSCALE_AUTH_KEY`.
# 2. Nilai secret HARUS berupa "Ephemeral" dan "Pre-authorized" Auth Key
#    dari konsol admin Tailscale Anda.
# -----------------------------------------------------------------------------------

name: "üöÄ ditzz RDP (Tailscale | Win11-ARM)"

on:
  workflow_dispatch:

jobs:
  rdp-session:
    name: "üñ•Ô∏è Windows 11 ARM | RDP via Tailscale"
    runs-on: windows-11-arm
    timeout-minutes: 360

    steps:
      - name: "‚îå üìù Parameter Sesi"
        shell: pwsh
        run: |
          Write-Host "==========================================================================" -ForegroundColor Green
          Write-Host "         üöÄ Memulai Sesi RDP untuk ditzz-devnest via Tailscale" -ForegroundColor Cyan
          Write-Host "=========================================================================="
          Write-Host "üîπ Sistem Operasi : Windows 11 ARM"
          Write-Host "üîπ Metode Akses   : RDP via Tailscale Private Network"
          Write-Host "üîπ Aktor          : ${{ github.actor }}"
          Write-Host "üîπ Repositori     : ${{ github.repository }}"
          Write-Host "=========================================================================="

      - name: "‚îú üîê Validasi Tailscale Auth Key"
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
            Write-Error "‚ùå Secret 'TAILSCALE_AUTH_KEY' tidak ditemukan!"
            exit 1
          }
          Write-Host "‚úÖ Secret Tailscale berhasil divalidasi." -ForegroundColor Green
          
      - name: "‚îú ‚öôÔ∏è Konfigurasi RDP dan Buat Pengguna"
        shell: pwsh
        run: |
          Write-Host "üîê Membuat kata sandi yang aman untuk pengguna RDP..."
          $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object { [char]$_ })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          Write-Host "üë§ Membuat pengguna 'ditzz' dan menambahkannya ke grup Administrator..."
          New-LocalUser -Name "ditzz" -Password $securePass -FullName "ditzz-devnest"
          Add-LocalGroupMember -Group "Administrators" -Member "ditzz"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ditzz"
          
          Write-Host "‚úÖ Pengguna 'ditzz' berhasil dibuat." -ForegroundColor Green
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

          Write-Host "üîß Mengaktifkan Remote Desktop dan membuka port firewall..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="Allow RDP" dir=in action=allow protocol=TCP localport=3389
          
          Write-Host "‚úÖ Konfigurasi RDP dan Firewall selesai." -ForegroundColor Green

      - name: "‚îú üåê Instal & Konfigurasi Tailscale"
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "üì• Mengunduh versi terbaru Tailscale..."
          # Menggunakan URL yang selalu menunjuk ke versi stabil terbaru
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi" -OutFile "tailscale.msi"
          
          Write-Host "‚öôÔ∏è Menginstal Tailscale..."
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet" -Wait
          
          # Membuat hostname unik untuk runner ini
          $hostname = "gh-runner-ditzz-${{ github.run_number }}"
          echo "TS_HOSTNAME=$hostname" >> $env:GITHUB_ENV
          
          Write-Host "üöÄ Menghubungkan ke Tailscale dengan hostname '$hostname'..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TAILSCALE_AUTH_KEY" --hostname="$hostname" --accept-routes

          Write-Host "‚úÖ Perintah koneksi Tailscale telah dieksekusi." -ForegroundColor Green
          
      - name: "‚îî ‚úÖ Verifikasi Koneksi & Tampilkan Info"
        shell: pwsh
        run: |
          $max_retries = 12
          $retry_delay_seconds = 5
          $ts_ip = $null

          Write-Host "üì° Memverifikasi koneksi Tailscale..."
          for ($i = 1; $i -le $max_retries; $i++) {
              $status = (& "C:\Program Files\Tailscale\tailscale.exe" status --json | ConvertFrom-Json)
              if ($status.BackendState -eq "Running" -and $status.Self.Online) {
                  $ts_ip = $status.Self.TailscaleIPs[0]
                  Write-Host "‚úÖ Koneksi Tailscale stabil dan online (IP: $ts_ip)." -ForegroundColor Green
                  break
              }
              if ($i -lt $max_retries) {
                  Write-Host "Percobaan $i: Koneksi belum siap. Menunggu $retry_delay_seconds detik..."
                  Start-Sleep -Seconds $retry_delay_seconds
              } else {
                  Write-Error "‚ùå Gagal mendapatkan koneksi Tailscale yang stabil setelah $max_retries percobaan."
                  exit 1
              }
          }
          
          Write-Host "==========================================================================" -ForegroundColor Green
          Write-Host "                       ‚úÖ SESI RDP ANDA SIAP ‚úÖ" -ForegroundColor Cyan
          Write-Host "=========================================================================="
          Write-Host "Gunakan salah satu alamat di bawah ini untuk terhubung:"
          Write-Host "üíª Alamat IP       : $ts_ip" -ForegroundColor White
          Write-Host "üñ•Ô∏è  Hostname        : ${{ env.TS_HOSTNAME }}" -ForegroundColor White
          Write-Host "--------------------------------------------------------------------------"
          Write-Host "üë§ Nama Pengguna   : ditzz" -ForegroundColor White
          Write-Host "üîë Kata Sandi      : ${{ env.RDP_PASSWORD }}" -ForegroundColor White
          Write-Host "=========================================================================="
          
          while ($true) {
              $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Write-Host "[$timestamp] Sesi RDP aktif. Tekan 'Cancel workflow' untuk menghentikan."
              Start-Sleep -Seconds 300
          }
